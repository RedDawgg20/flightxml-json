name: Regenerate from WSDL

# on:
#   schedule:
#     - cron:  '0 4 * * *'
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Ruby 2.6
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.6'
        architecture: 'x64'
    - name: Regenerate files
      run: |
        rake -f Rakefile flightxml:generate
    - name: Create Pull Request
      run: |
        if [ ! -z "$(git status --porcelain)" ]; then
          branch_name="`date "+%Y-%m-%d"`-wsdl-update"
          git checkout -b $branch_name
          git add .
          git config user.email jake@tolerable.tech
          git config user.name Jake Wilkins
          git commit -m "Regenerate based on updated WSDL"
          git push origin $branch_name

          data='\'"title": "Regenerate for updated WSDL", "head": "BRANCH_NAME", "base": "master", "body": "FlightAware published an updated WSDL. This regenerates our code based upon updated definitions"\''
          data=`echo $data | sed "s/BRANCH_NAME/$branch_name/"`

          curl --request POST\
            --url https://api.github.com/repos/jakewilkins/flightxml-json/pulls\
            --header "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"\
            --header 'content-type: application/json' \
            --data $data
        fi
